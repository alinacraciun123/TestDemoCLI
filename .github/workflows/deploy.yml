name: UiPath CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_PATH: "project.json"
  ORCHESTRATOR_URL: "https://staging.uipath.com/uipatcvdtryn/DefaultTenant/orchestrator_"
  ORCHESTRATOR_FOLDER: "express"
  ORCHESTRATOR_TENANT: "DefaultTenant"
  IDENTITY_URL: "https://staging.uipath.com/identity_"
  TEST_SET: "Test_Set_TestDemoCli_Tests"
  TEST_MANAGER_PROJECT: "TestDemo"

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Pack Project
        run: |
          Write-Host "=========================================="
          Write-Host "Packing UiPath Project"
          Write-Host "=========================================="
          
          .\Scripts\UiPathPack.ps1 "${{ env.PROJECT_PATH }}" `
            -destination_folder ".\Output" `
            -outputType "Process"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Packing failed!"
            exit 1
          }
          
          $package = Get-ChildItem -Path ".\Output" -Filter "*.nupkg" | Select-Object -First 1
          echo "PACKAGE_PATH=$($package.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "PACKAGE_NAME=$($package.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "‚úì Package created: $($package.Name)" -ForegroundColor Green
        shell: pwsh

      - name: Deploy to Orchestrator
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying to Orchestrator"
          Write-Host "=========================================="
          
          .\Scripts\UiPathDeploy.ps1 `
            "${{ env.PACKAGE_PATH }}" `
            "${{ env.ORCHESTRATOR_URL }}" `
            "${{ env.ORCHESTRATOR_TENANT }}" `
            -folder_organization_unit "${{ env.ORCHESTRATOR_FOLDER }}" `
            -accountForApp "accountForExternalApp" `
            -applicationId "${{ secrets.APP_ID }}" `
            -applicationSecret "${{ secrets.SECRET }}" `
            -applicationScope "OR.Execution OR.Folders OR.TestSets OR.TestSetExecutions OR.TestSetSchedules"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Deployment failed!"
            exit 1
          }
          
          Write-Host "‚úì Deployment successful: ${{ env.PACKAGE_NAME }}" -ForegroundColor Green
        shell: pwsh

  test:
    runs-on: windows-latest
    needs: build-and-deploy
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run Test Set
        run: |
          Write-Host "=========================================="
          Write-Host "Executing Test Set: ${{ env.TEST_SET }}"
          Write-Host "Test Manager Project: ${{ env.TEST_MANAGER_PROJECT }}"
          Write-Host "=========================================="
          
          .\Scripts\UiPathRunTests.ps1 `
            -orchestratorUrl "${{ env.ORCHESTRATOR_URL }}" `
            -orchestratorTenant "${{ env.ORCHESTRATOR_TENANT }}" `
            -folderName "${{ env.ORCHESTRATOR_FOLDER }}" `
            -testSet "${{ env.TEST_SET }}" `
            -orchestratorApplicationId "${{ secrets.APP_ID }}" `
            -orchestratorApplicationSecret "${{ secrets.SECRET }}" `
            -orchestratorApplicationScope "OR.Execution OR.Folders OR.TestSets OR.TestSetExecutions OR.TestSetSchedules" `
            -identityUrl "${{ env.IDENTITY_URL }}" `
            -testResultsOutputPath ".\TestResults" `
            -timeout 3600
          
          $exitCode = $LASTEXITCODE
          
          Write-Host ""
          Write-Host "=========================================="
          if ($exitCode -eq 0) {
            Write-Host "‚úì All tests passed successfully!" -ForegroundColor Green
            Write-Host ""
            Write-Host "View detailed results in Test Manager:" -ForegroundColor Cyan
            Write-Host "  üìä Project: ${{ env.TEST_MANAGER_PROJECT }}" -ForegroundColor Cyan
            Write-Host "  üìã Test Set: ${{ env.TEST_SET }}" -ForegroundColor Cyan
            Write-Host "  üîó URL: ${{ env.ORCHESTRATOR_URL }}" -ForegroundColor Cyan
          } else {
            Write-Host "‚úó Tests failed!" -ForegroundColor Red
            Write-Host ""
            Write-Host "Check Test Manager for detailed failure information:" -ForegroundColor Yellow
            Write-Host "  üìä Project: ${{ env.TEST_MANAGER_PROJECT }}" -ForegroundColor Yellow
            Write-Host "  üìã Test Set: ${{ env.TEST_SET }}" -ForegroundColor Yellow
            Write-Host "  üîó URL: ${{ env.ORCHESTRATOR_URL }}" -ForegroundColor Yellow
          }
          Write-Host "=========================================="
          
          exit $exitCode
        shell: pwsh

      - name: Upload Test Results Artifact
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: ./TestResults/**/*
          retention-days: 30

      - name: Test Results Summary
        if: always()
        run: |
          Write-Host ""
          Write-Host "================================================"
          Write-Host "           TEST EXECUTION SUMMARY"
          Write-Host "================================================"
          Write-Host ""
          Write-Host "‚úì Test results recorded in Test Manager"
          Write-Host ""
          Write-Host "üìç Location:"
          Write-Host "   Project: ${{ env.TEST_MANAGER_PROJECT }}"
          Write-Host "   Test Set: ${{ env.TEST_SET }}"
          Write-Host "   Folder: ${{ env.ORCHESTRATOR_FOLDER }}"
          Write-Host ""
          Write-Host "üîç To view results:"
          Write-Host "   1. Log in to UiPath Orchestrator"
          Write-Host "   2. Navigate to Test Manager"
          Write-Host "   3. Open project: ${{ env.TEST_MANAGER_PROJECT }}"
          Write-Host "   4. Check latest execution of: ${{ env.TEST_SET }}"
          Write-Host ""
          Write-Host "üì¶ Local results also saved as GitHub artifacts"
          Write-Host "================================================"
        shell: pwsh
