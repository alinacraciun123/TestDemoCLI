name: UiPath CI - Build Deploy Test

on:
  push:
    branches: [ main ]

env:
  ORCHESTRATOR_URL: https://staging.uipath.com/
  ORCHESTRATOR_TENANT: DefaultTenant
  ORCHESTRATOR_FOLDER: express
  ORCH_ACCOUNT_NAME: uipatcvdtryn

  TEST_SET: Test_Set_TestDemoCli_Tests

  CLI_VERSION: 24.12.9166.24491
  CLI_URL: https://uipath.pkgs.visualstudio.com/Public.Feeds/_packaging/UiPath-Official/nuget/v3/flat2/uipath.cli.windows/24.12.9166.24491/uipath.cli.windows.24.12.9166.24491.nupkg

  ORCH_CLIENT_ID: ${{ secrets.APP_ID }}
  ORCH_SECRET: ${{ secrets.SECRET }}

jobs:
  build-deploy-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install UiPath CLI
        shell: pwsh
        run: |
          $path = "C:\uipathcli"
          New-Item -ItemType Directory -Force -Path $path | Out-Null
          Invoke-WebRequest "$env:CLI_URL" -OutFile "$path\cli.zip"
          Expand-Archive "$path\cli.zip" -DestinationPath $path -Force
          & "$path\tools\uipcli.exe" --version

      - name: Pack Process
        shell: pwsh
        run: |
          & "C:\uipathcli\tools\uipcli.exe" package pack `
            "$env:GITHUB_WORKSPACE\project.json" `
            --output "$env:GITHUB_WORKSPACE\package" `
            --outputType Process `
            --autoVersion

      - name: Pack Tests
        shell: pwsh
        run: |
          & "C:\uipathcli\tools\uipcli.exe" package pack `
            "$env:GITHUB_WORKSPACE\project.json" `
            --output "$env:GITHUB_WORKSPACE\package" `
            --outputType Tests `
            --autoVersion

      - name: Deploy Process Package
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"

          $processPkg = Get-ChildItem "$env:GITHUB_WORKSPACE\package\*.nupkg" |
            Where-Object { $_.Name -notlike "*Tests*" } |
            Select-Object -First 1

          & $CLI package deploy `
            "$($processPkg.FullName)" `
            "$env:ORCHESTRATOR_URL" `
            "$env:ORCHESTRATOR_TENANT" `
            -A "$env:ORCH_ACCOUNT_NAME" `
            -I "$env:ORCH_CLIENT_ID" `
            -S "$env:ORCH_SECRET" `
            --applicationScope "OR.Folders OR.Execution OR.Assets OR.Jobs OR.Robots OR.Machines OR.Settings" `
            --organizationUnit "$env:ORCHESTRATOR_FOLDER" `
            --createProcess false

      - name: Deploy Test Package
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"

          $testPkg = Get-ChildItem "$env:GITHUB_WORKSPACE\package\*Tests*.nupkg" |
            Select-Object -First 1

          & $CLI package deploy `
            "$($testPkg.FullName)" `
            "$env:ORCHESTRATOR_URL" `
            "$env:ORCHESTRATOR_TENANT" `
            -A "$env:ORCH_ACCOUNT_NAME" `
            -I "$env:ORCH_CLIENT_ID" `
            -S "$env:ORCH_SECRET" `
            --applica
