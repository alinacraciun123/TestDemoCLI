name: UiPath CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_PATH: project.json
  ORCHESTRATOR_URL: https://staging.uipath.com/
  ORCHESTRATOR_FOLDER: express
  ORCHESTRATOR_TENANT: DefaultTenant
  TEST_SET: Test_Set_TestDemoCli_Tests
  TEST_MANAGER_PROJECT: TestDemo

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Print Working Directory
        run: |
          pwd
          ls

      - name: Setup .NET 6.0
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Get UiPath CLI
        run: |
          $cliDir = "C:\uipathcli"
          if (-Not (Test-Path $cliDir)) { New-Item -Path "C:\" -ItemType "directory" -Name "uipathcli" }
          $nugetUrl = "https://uipath.pkgs.visualstudio.com/Public.Feeds/_packaging/UiPath-Official/nuget/v3/flat2/UiPath.CLI.Windows/23.2.8467.25277/UiPath.CLI.Windows.23.2.8467.25277.nupkg"
          $zipPath = "C:\UiPath.CLI.Windows.23.2.8467.25277.zip"
          Invoke-WebRequest $nugetUrl -OutFile $zipPath
          Expand-Archive -LiteralPath $zipPath -DestinationPath $cliDir

      - name: Pack Project
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $outputDir = Join-Path $workspace "Output"
          if (-Not (Test-Path $outputDir)) { New-Item -ItemType Directory -Path $outputDir }

          Write-Host "=========================================="
          Write-Host "Packing UiPath Project"
          Write-Host "=========================================="

          & .\Scripts\UiPathPack.ps1 $env:PROJECT_PATH -destination_folder $outputDir -outputType Process
          if ($LASTEXITCODE -ne 0) { Write-Error "Packing failed!"; exit 1 }

          $package = Get-ChildItem -Path $outputDir -Filter "*.nupkg" | Select-Object -First 1
          echo "PACKAGE_PATH=$($package.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "PACKAGE_NAME=$($package.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          Write-Host "✓ Package created: $($package.Name)" -ForegroundColor Green

      - name: Deploy to Orchestrator
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "Deploying to Orchestrator"
          Write-Host "=========================================="

          & .\Scripts\UiPathDeploy.ps1 `
              $env:PACKAGE_PATH `
              $env:ORCHESTRATOR_URL `
              $env:ORCHESTRATOR_TENANT `
              -folder_organization_unit $env:ORCHESTRATOR_FOLDER `
              -accountForApp accountForExternalApp `
              -applicationId ${{ secrets.APP_ID }} `
              -applicationSecret ${{ secrets.SECRET }} `
              -applicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Machines.Read OR.Monitoring OR.Robots.Read OR.Settings.Read OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Users.Read"

          if ($LASTEXITCODE -ne 0) { Write-Error "Deployment failed!"; exit 1 }

          Write-Host "✓ Deployment successful: $env:PACKAGE_NAME" -ForegroundColor Green

  test:
    runs-on: windows-latest
    needs: build-and-deploy

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run Test Set
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "Executing Test Set: $env:TEST_SET"
          Write-Host "Test Manager Project: $env:TEST_MANAGER_PROJECT"
          Write-Host "=========================================="

          & .\Scripts\UiPathRunTests.ps1 `
              -orchestratorUrl $env:ORCHESTRATOR_URL `
              -orchestratorTenant $env:ORCHESTRATOR_TENANT `
              -folderName $env:ORCHESTRATOR_FOLDER `
              -testSet $env:TEST_SET `
              -orchestratorApplica
