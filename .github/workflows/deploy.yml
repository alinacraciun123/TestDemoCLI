name: UiPathRunTests

on:
  push:
    branches:
      - main

env:
  PROJECT_NAME: TestDemoCLI
  ORCHESTRATOR_URL: https://staging.uipath.com/
  ORCHESTRATOR_TENANT: DefaultTenant
  ORCHESTRATOR_FOLDER: express
  ORCH_ACCOUNT_NAME: uipatcvdtryn
  TEST_SET: Test_Set_TestDemoCli_Tests
  CLI_VERSION: 24.12.9166.24491
  CLI_URL: https://uipath.pkgs.visualstudio.com/Public.Feeds/_packaging/UiPath-Official/nuget/v3/flat2/uipath.cli.windows/24.12.9166.24491/uipath.cli.windows.24.12.9166.24491.nupkg
  DOTNET_ROOT: C:\Program Files\dotnet
  ORCH_CLIENT_ID: ${{ secrets.APP_ID }}
  ORCH_SECRET: ${{ secrets.SECRET }}

jobs:
  Build-Pack-Deploy-Test:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Print Working Directory
        run: |
          pwd
          ls

      # Install UiPath CLI
      - name: Download UiPath CLI
        shell: pwsh
        run: |
          $cliDir = "C:\uipathcli"
          New-Item -ItemType Directory -Force -Path $cliDir | Out-Null
          Invoke-WebRequest "$env:CLI_URL" -OutFile "$cliDir\cli.zip"
          Expand-Archive "$cliDir\cli.zip" -DestinationPath $cliDir -Force
          & "$cliDir\tools\uipcli.exe" --version

      # Pack process packages
      - name: Pack Process Project
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $project = "$env:GITHUB_WORKSPACE\project.json"
          $pkgDir = "$env:GITHUB_WORKSPACE\package"
          New-Item -ItemType Directory -Force -Path $pkgDir | Out-Null
          & $CLI package pack "$project" --output "$pkgDir" --outputType Process --autoVersion

      # Pack tests
      - name: Pack Test Project
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $project = "$env:GITHUB_WORKSPACE\project.json"
          & $CLI package pack "$project" --output "$env:GITHUB_WORKSPACE\package" --outputType Tests --autoVersion

      # Deploy process
      - name: Deploy Process Package
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $pkg = Get-ChildItem "$env:GITHUB_WORKSPACE\package\*.nupkg" | Where-Object { $_.Name -notlike '*Tests*' } | Select-Object -First 1
          & $CLI package deploy "$($pkg.FullName)" "$env:ORCHESTRATOR_URL" "$env:ORCHESTRATOR_TENANT" `
            -A "$env:ORCH_ACCOUNT_NAME" -I "$env:ORCH_CLIENT_ID" -S "$env:ORCH_SECRET" `
            --applicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Machines OR.Monitoring OR.Robots OR.Settings OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Users" `
            --processName "TestDemoCli" --createProcess true --entryPointsPath "Main.xaml" --organizationUnit "$env:ORCHESTRATOR_FOLDER"

      # Deploy tests
      - name: Deploy Test Package
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $testPkg = Get-ChildItem "$env:GITHUB_WORKSPACE\package\*Tests*.nupkg" | Select-Object -First 1
          if ($testPkg) {
              & $CLI package deploy "$($testPkg.FullName)" "$env:ORCHESTRATOR_URL" "$env:ORCHESTRATOR_TENANT" `
                  -A "$env:ORCH_ACCOUNT_NAME" -I "$env:ORCH_CLIENT_ID" -S "$env:ORCH_SECRET" `
                  --applicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Machines OR.Monitoring OR.Robots OR.Settings OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Users" `
                  --organizationUnit "$env:ORCHESTRATOR_FOLDER"
          }

      # Run Test Set via CLI against Orchestrator
      - name: Run Test Set
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\TestResults" | Out-Null

          & $CLI test run `
              "$env:ORCHESTRATOR_URL" `
              "$env:ORCHESTRATOR_TENANT" `
              -P "$env:GITHUB_WORKSPACE\package\*Tests*.nupkg" `
              -s "$env:TEST_SET" `
              -o "$env:ORCHESTRATOR_FOLDER" `
              -A "$env:ORCH_ACCOUNT_NAME" `
              -I "$env:ORCH_CLIENT_ID" `
              -S "$env:ORCH_SECRET" `
              --applicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Machines OR.Monitoring OR.Robots OR.Settings OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Users" `
              --identityURL "https://staging.uipath.com/identity" `
              --out junit `
              --result_path "$env:GITHUB_WORKSPACE\TestResults"

      # Publish JUnit results
      - name: Publish Test Results
        uses: dorny/test-reporter@v1
        with:
          name: UiPath Tests
          path: ${{ github.workspace }}/TestResults/**/*.xml
          reporter: junit
          fail-on-error: true
