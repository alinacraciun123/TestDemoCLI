name: UiPathRunTests

on:
  push:
    branches:
      - main

env:
  PROJECT_NAME: TestDemoCLI
  ORCHESTRATOR_URL: https://staging.uipath.com/
  ORCHESTRATOR_TENANT: DefaultTenant
  ORCHESTRATOR_FOLDER: express
  Orch_ACC_NAME: uipatcvdtryn
  TEST_SET: Test_Set_TestDemoCli_Tests
  CLI_VERSION: 24.12.9166.24491
  CLI_URL: https://uipath.pkgs.visualstudio.com/Public.Feeds/_packaging/UiPath-Official/nuget/v3/flat2/uipath.cli.windows/24.12.9166.24491/uipath.cli.windows.24.12.9166.24491.nupkg
  DOTNET_ROOT: C:\Program Files\dotnet
  ORCH_CLIENT_ID: ${{ secrets.APP_ID }}
  ORCH_SECRET: ${{ secrets.SECRET }}

jobs:
  Build-Pack-Deploy-Test:
    runs-on: windows-latest
    steps:
      # Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Print Working Directory
        run: |
          pwd
          ls

      # Download UiPath CLI
      - name: Download UiPath CLI
        shell: pwsh
        run: |
          $cli = "C:\uipathcli"
          New-Item -ItemType Directory -Force -Path $cli | Out-Null
          Write-Host "Downloading UiPath CLI from $env:CLI_URL ..."
          Invoke-WebRequest "$env:CLI_URL" -OutFile "$cli\cli.zip"
          Expand-Archive "$cli\cli.zip" -DestinationPath $cli -Force
          Write-Host "CLI extracted to: $cli"

          # Verify CLI
          $cliPath = "$cli\tools\uipcli.exe"
          if (Test-Path $cliPath) {
              Write-Host "✓ CLI installed successfully"
              & $cliPath --version
          }

      # PACK the automation project (Process package)
      - name: Pack Process Project
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $project = "$env:GITHUB_WORKSPACE\project.json"
          $outDir = "$env:GITHUB_WORKSPACE\package"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          Write-Host "Packing process project..."
          & $CLI package pack `
              "$project" `
              --output "$outDir" `
              --outputType Process `
              --autoVersion

          if ($LASTEXITCODE -eq 0) {
              $pkg = Get-ChildItem "$outDir\*.nupkg" | Select-Object -First 1
              Write-Host "✓ Process package created: $($pkg.Name)"
          } else {
              Write-Error "✗ Pack failed"
              exit 1
          }

      # PACK the test project (Test package)
      - name: Pack Test Project
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $project = "$env:GITHUB_WORKSPACE\project.json"
          $outDir = "$env:GITHUB_WORKSPACE\package"

          Write-Host "Packing test project..."
          & $CLI package pack `
              "$project" `
              --output "$outDir" `
              --outputType Tests `
              --autoVersion

          if ($LASTEXITCODE -eq 0) {
              $testPkgs = Get-ChildItem "$outDir\*Tests*.nupkg"
              if ($testPkgs) {
                  Write-Host "✓ Test package created: $($testPkgs[0].Name)"
              }
          } else {
              Write-Warning "⚠ Test pack may have issues (this is ok if no tests exist)"
          }

      # List all packages
      - name: List Packages
        shell: pwsh
        run: |
          Write-Host "Packages created:"
          Get-ChildItem "$env:GITHUB_WORKSPACE\package\*.nupkg" | ForEach-Object {
              Write-Host "  - $($_.Name)"
          }

      # DEPLOY the process package
      - name: Deploy Process Package to Orchestrator
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $pkg = Get-ChildItem "$env:GITHUB_WORKSPACE\package\*.nupkg" | Where-Object { $_.Name -notlike "*Tests*" } | Select-Object -First 1

          if (-not $pkg) {
              Write-Error "✗ No process package found"
              exit 1
          }

          Write-Host "Deploying process package: $($pkg.FullName)"
          & $CLI package deploy `
              "$($pkg.FullName)" `
              "$env:ORCHESTRATOR_URL" `
              "$env:ORCHESTRATOR_TENANT" `
              -A "$env:Orch_ACC_NAME" `
              -I "$env:ORCH_CLIENT_ID" `
              -S "$env:ORCH_SECRET" `
              --applicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Machines OR.Monitoring OR.Robots OR.Settings OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Users" `
              --processName "TestDemoCli" `
              --createProcess true `
              --entryPointsPath "Main.xaml" `
              --organizationUnit "$env:ORCHESTRATOR_FOLDER"

          if ($LASTEXITCODE -eq 0) {
              Write-Host "✓ Process package deployed successfully"
          } else {
              Write-Error "✗ Deploy failed"
              exit 1
          }

      # DEPLOY the test package
      - name: Deploy Test Package to Orchestrator
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $testPkg = Get-ChildItem "$env:GITHUB_WORKSPACE\package\*Tests*.nupkg" | Select-Object -First 1

          if (-not $testPkg) {
              Write-Warning "⚠ No test package found to deploy"
              exit 0
          }

          Write-Host "Deploying test package: $($testPkg.FullName)"
          & $CLI package deploy `
              "$($testPkg.FullName)" `
              "$env:ORCHESTRATOR_URL" `
              "$env:ORCHESTRATOR_TENANT" `
              -A "$env:Orch_ACC_NAME" `
              -I "$env:ORCH_CLIENT_ID" `
              -S "$env:ORCH_SECRET" `
              --applicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Machines OR.Monitoring OR.Robots OR.Settings OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Users" `
              --organizationUnit "$env:ORCHESTRATOR_FOLDER"

          if ($LASTEXITCODE -eq 0) {
              Write-Host "✓ Test package deployed successfully"
          } else {
              Write-Warning "⚠ Test package deploy had issues"
          }

      # RUN TESTS via CLI from Orchestrator with JUnit output
      - name: Run Test Set via CLI (Orchestrator)
        shell: pwsh
        run: |
          $CLI = "C:\uipathcli\tools\uipcli.exe"
          $resultDir = "$env:GITHUB_WORKSPACE\TestResults"
          New-Item -ItemType Directory -Force -Path $resultDir | Out-Null

          Write-Host "Running Test Set '$env:TEST_SET' from Orchestrator..."

          & $CLI test run `
              "$env:ORCHESTRATOR_URL" `
              "$env:ORCHESTRATOR_TENANT" `
              -A "$env:Orch_ACC_NAME" `
              -I "$env:ORCH_CLIENT_ID" `
              -S "$env:ORCH_SECRET" `
              --applicationScope "OR.Assets OR.BackgroundTasks OR.Execution OR.Folders OR.Jobs OR.Machines OR.Monitoring OR.Robots OR.Settings OR.TestSetExecutions OR.TestSets OR.TestSetSchedules OR.Users" `
              --identityUrl "https://staging.uipath.com/identity" `
              --out junit `
              --executionArtifactsDirectoryPath "$resultDir" `
              --testSetName "$env:TEST_SET"

      # Upload JUnit test results to GitHub
      - name: Publish Test Results
        uses: actions/upload-test-results@v3
        with:
          test-results-files: 'TestResults/**/*.xml'
          fail-on-error: true
          fail-on-empty: true
          token: ${{ secrets.GITHUB_TOKEN }}
